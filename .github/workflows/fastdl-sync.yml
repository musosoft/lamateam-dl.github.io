name: Smart FastDL Sync

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *' # Daily at 4 AM

permissions:
  contents: write

jobs:
  smart-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true             # LFS Enabled for your custom maps
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y lftp bzip2 rsync

      - name: Check Reference & Defaults Cache
        id: check_cache
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USERNAME }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          REMOTE_PATH: ${{ secrets.FTP_REMOTE_PATH }}
        run: |
          set -euo pipefail
          
          # Initialize directory
          mkdir -p _excludes
          
          echo "::group::Checking Server Reference"
          RAW_REF=$(lftp -u "$FTP_USER,$FTP_PASS" -e "set ssl:verify-certificate no; cd '$REMOTE_PATH'; cls -l maps/test_speakers.bsp; quit" "$FTP_HOST")
          
          # Extract Date Signature (e.g. "May 11 2025")
          # Strict YYYY format check to ensure it's a default file
          CURRENT_SIG=$(echo "$RAW_REF" | grep -oE '[A-Za-z]{3}\s+[0-9]{1,2}\s+[0-9]{4}' | head -n 1 || true)
          echo "Server Signature: '$CURRENT_SIG'"
          
          CACHE_FILE="_excludes/reference.sig"
          REBUILD_DEFAULTS="true"
          
          if [ -f "$CACHE_FILE" ] && [ -n "$CURRENT_SIG" ]; then
            CACHED_SIG=$(cat "$CACHE_FILE")
            # We also check if defaults_maps.txt actually exists/is non-empty, otherwise force rebuild
            if [ "$CURRENT_SIG" == "$CACHED_SIG" ] && [ -s "_excludes/defaults_maps.txt" ]; then
              echo "âœ… Cache Hit! Defaults list is valid."
              REBUILD_DEFAULTS="false"
            else
              echo "âš ï¸  Cache Miss (or file missing). Rebuilding Defaults."
            fi
          fi
          
          echo "rebuild=$REBUILD_DEFAULTS" >> $GITHUB_OUTPUT
          echo "current_sig=$CURRENT_SIG" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Build 'Defaults' Exclude List (Cached)
        if: steps.check_cache.outputs.rebuild == 'true'
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USERNAME }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          REMOTE_PATH: ${{ secrets.FTP_REMOTE_PATH }}
          REF_SIG: ${{ steps.check_cache.outputs.current_sig }}
        run: |
          set -euo pipefail
          
          echo "::group::Scanning FTP for Default Batch"
          echo "$REF_SIG" > "_excludes/reference.sig"
          
          if [ -z "$REF_SIG" ]; then
            echo "âŒ ERROR: No Year-based date found. Cannot determine defaults."
            # Create empty files to prevent crash
            for d in maps materials models sound resource; do : > "_excludes/defaults_${d}.txt"; done
            exit 0
          fi
          
          scan_defaults() {
            local dir=$1
            # Filter: Match Date, Match Year, NO Time
            lftp -u "$FTP_USER,$FTP_PASS" -e "set ssl:verify-certificate no; cd '$REMOTE_PATH'; cls -l $dir; quit" "$FTP_HOST" \
            | awk -v ref="$REF_SIG" '$0 ~ ref && $0 ~ /[0-9]{4}/ && $0 !~ /:[0-9]{2}/ { print $NF }' \
            | sort -u > "_excludes/defaults_${dir}.txt"
          }
          
          scan_defaults "maps"
          scan_defaults "materials"
          scan_defaults "models"
          scan_defaults "sound"
          scan_defaults "resource" 

          # Always exclude the reference files
          echo "test_speakers.bsp" >> "_excludes/defaults_maps.txt"
          echo "test_hardware.bsp" >> "_excludes/defaults_maps.txt"
          echo "::endgroup::"

      - name: Build 'Repo' Exclude List (Always Fresh)
        run: |
          set -euo pipefail
          echo "::group::Scanning Local Repo for Existing Files"
          
          # Create empty repo lists
          for d in maps materials models sound resource; do : > "_excludes/repo_${d}.txt"; done

          if [ -d cstrike ]; then
            # Find all .bz2 files, strip paths and extensions, save to repo list
            # We use sed to ensure we get just the filename "my_map.bsp" from "cstrike/maps/my_map.bsp.bz2"
            find cstrike -type f -name "*.bz2" | while read -r f; do
              rel="${f#cstrike/}"         # maps/my_map.bsp.bz2
              dir="${rel%%/*}"            # maps
              filename="${rel#*/}"        # my_map.bsp.bz2
              clean_name="${filename%.bz2}" # my_map.bsp
              
              if [ -f "_excludes/repo_${dir}.txt" ]; then
                echo "$clean_name" >> "_excludes/repo_${dir}.txt"
              fi
            done
          fi
          echo "::endgroup::"

      - name: Merge Lists for LFTP
        run: |
          set -euo pipefail
          echo "::group::Merging Lists"
          
          # Combine Defaults + Repo into the final file lftp uses
          for d in maps materials models sound resource; do
             cat "_excludes/defaults_${d}.txt" "_excludes/repo_${d}.txt" | sort -u > "_excludes/final_${d}.txt"
             echo "Final Excludes for $d: $(wc -l < "_excludes/final_${d}.txt") files"
          done
          echo "::endgroup::"

      - name: Mirror Custom Content
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USERNAME }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          REMOTE_PATH: ${{ secrets.FTP_REMOTE_PATH }}
        run: |
          set -euo pipefail
          rm -rf _ftp
          mkdir -p _ftp/maps _ftp/materials _ftp/models _ftp/sound _ftp/resource

          echo "::group::ðŸ“¥ DOWNLOADING FILES"
          lftp -c "
            set cmd:fail-exit yes;
            set ssl:verify-certificate no;
            set ftp:passive-mode true;
            open -u '$FTP_USER','$FTP_PASS' '$FTP_HOST';
            cd '$REMOTE_PATH';
            
            # We use final_*.txt which GUARANTEES we don't download files present in repo
            
            mirror --continue --parallel=5 --verbose=1 --exclude-glob-from=_excludes/final_maps.txt --include-glob \"*.bsp\" --include-glob \"*.nav\" --include-glob \"*.res\" maps _ftp/maps;
            mirror --continue --parallel=5 --verbose=1 --exclude-glob-from=_excludes/final_materials.txt --include-glob \"*.vmt\" --include-glob \"*.vtf\" materials _ftp/materials;
            mirror --continue --parallel=5 --verbose=1 --exclude-glob-from=_excludes/final_models.txt --include-glob \"*.mdl\" --include-glob \"*.vvd\" --include-glob \"*.vtx\" --include-glob \"*.phy\" models _ftp/models;
            mirror --continue --parallel=5 --verbose=1 --exclude-glob-from=_excludes/final_sound.txt --include-glob \"*.wav\" --include-glob \"*.mp3\" sound _ftp/sound;
            mirror --continue --parallel=5 --verbose=1 --exclude-glob-from=_excludes/final_resource.txt --include-glob \"*.txt\" resource _ftp/resource;
            quit"
          echo "::endgroup::"

      - name: Compress and Merge
        run: |
          set -euo pipefail
          mkdir -p _out
          rsync -a _ftp/ _out/

          echo "::group::ðŸ“¦ COMPRESSING FILES"
          find _out -type f ! -type l \( \
            -name "*.bsp" -o -name "*.nav" -o -name "*.res" -o \
            -name "*.vmt" -o -name "*.vtf" -o \
            -name "*.mdl" -o -name "*.vvd" -o -name "*.vtx" -o -name "*.phy" -o \
            -name "*.wav" -o -name "*.mp3" -o \
            -name "*.txt" \
          \) -print0 | while IFS= read -r -d '' f; do
            if [ -s "$f" ]; then
              bzip2 -z -f "$f" || echo "WARNING: Failed to compress $f"
            fi
          done
          echo "::endgroup::"

          mkdir -p cstrike
          rsync -av _out/ cstrike/

      - name: ðŸ§¹ Sanitize Repo (Enforce Excludes)
        run: |
          set -euo pipefail
          echo "::group::Cleaning Excluded Files from Repo"
          
          # Delete files that are in the exclude list but exist in repo (cleanup previous mistakes)
          for type in maps materials models sound resource; do
             list="_excludes/final_${type}.txt"
             dir="cstrike/${type}"
             if [ -f "$list" ] && [ -d "$dir" ]; then
                count=0
                while IFS= read -r file; do
                   [ -z "$file" ] && continue
                   # Delete bz2 and raw
                   if [ -f "${dir}/${file}.bz2" ]; then
                      rm -f "${dir}/${file}.bz2"
                      count=$((count+1))
                   fi
                   if [ -f "${dir}/${file}" ]; then
                      rm -f "${dir}/${file}"
                      count=$((count+1))
                   fi
                done < "$list"
                if [ "$count" -gt 0 ]; then
                   echo "Removed $count excluded files from $type"
                fi
             fi
          done
          echo "::endgroup::"

      - name: Push Updates
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "FastDL: Sync custom content"
          branch: main
          file_pattern: "cstrike/** _excludes/**"
